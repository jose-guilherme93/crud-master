name: Deploy na VPS de Produção

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4

      - name: 2. Configurar Variáveis de Ambiente e Arquivos de Deploy
        run: |
          echo "--- Criando .env de produção ---"
          echo "${{ secrets.PROD_ENV }}" > .env
          cat .env
          
          echo "--- Gerando docker-compose.prod.yml ---"
          cat <<'EOF' > docker-compose.prod.yml
          version: '3.8'

          services:
            app:
              build:
                context: .
                dockerfile: Dockerfile
              container_name: gamecatalog_app
              restart: always
              ports:
                - "3000:3000"
              environment:
                PG_HOST: postgres
                PG_USER: ${PG_USER} 
                PG_PASSWORD: ${PG_PASSWORD}
                PG_DATABASE: ${PG_DATABASE}
                NODE_ENV: production
                JWT_SECRET: ${JWT_SECRET}
              depends_on:
                - postgres
              env_file:
                - .env
                
            postgres:
              image: postgres:15
              container_name: postgres_crud
              restart: always
              environment:
                POSTGRES_USER: ${POSTGRES_USER}
                POSTGRES_PASSWORD: ${POSTES_PASSWORD}
                POSTGRES_DB: ${POSTGRES_DB}
              volumes:
                - pgdata:/var/lib/postgresql/data

          volumes:
            pgdata:
          EOF
                    cat docker-compose.prod.yml

                - name: 3. Transferir Arquivos via SCP (Mostrando o que será copiado)
                  uses: appleboy/scp-action@v0.1.7
                  with:
                    # Alterado para usar HOST
                    host: ${{ secrets.HOST }} 
                    # Alterado para usar USERNAME
                    username: ${{ secrets.USERNAME }} 
                    # Alterado para usar KEY
                    key: ${{ secrets.KEY }} 
                    target: /home/${{ secrets.USERNAME }}/gamecatalog
                    source: ".env,Dockerfile,package.json,pnpm-lock.yaml,tsconfig.json,src/,scripts/,docker-compose.prod.yml"
                    overwrite: true
                  run: echo "Arquivos copiados com sucesso."

                - name: 4. Executar Deploy Remoto via SSH (Com Logs de Build e Status)
                  uses: appleboy/ssh-action@v1.0.3
                  with:
                    # Alterado para usar HOST
                    host: ${{ secrets.HOST }}
                    # Alterado para usar USERNAME
                    username: ${{ secrets.USERNAME }}
                    # Alterado para usar KEY
                    key: ${{ secrets.KEY }}
                    script: |
                      echo "--- Iniciando Deploy na VPS ---"
                      cd /home/${{ secrets.USERNAME }}/gamecatalog
                      
                      echo "--- Verificando permissões ---"
                      sudo chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} .
                      
                      echo "--- Parando e Removendo Contêineres Antigos ---"
                      docker compose -f docker-compose.prod.yml down --timeout 5
                      
                      echo "--- Iniciando Build e Deploy (Isto deve levar tempo) ---"
                      docker compose -f docker-compose.prod.yml up -d --build --force-recreate --verbose
                      
                      echo "--- Verificação Final de Status ---"
                      docker compose -f docker-compose.prod.yml ps
                      
                      echo "--- Limpeza de Imagens Antigas ---"
                      docker image prune -f
                      
                      echo "Deploy concluído com sucesso!"