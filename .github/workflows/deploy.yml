name: 游 Deploy na VPS (Docker Compose)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite rodar manualmente

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Define as vari치veis de ambiente que ser칚o usadas em TODOS os passos
    # Elas s칚o mapeadas das Secrets do seu reposit칩rio
    env:
      # Vari치veis do Postgres (DB Secrets)
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      # Vari치veis de Conex칚o e Aplica칞칚o (App Secrets)
      PGPORT: ${{ secrets.PGPORT }}
      HOST: ${{ secrets.HOST }}
      KEY: ${{ secrets.KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      USERNAME: ${{ secrets.USERNAME }}
      
      # Vari치veis de Conex칚o SSH (VPS)
      SSH_HOST: ${{ secrets.HOST }}
      SSH_USER: ${{ secrets.USERNAME }}

    steps:
      - name: 拘勇 Checkout do C칩digo
        uses: actions/checkout@v4

      - name: 游댐 Configurar Chave SSH Privada
        uses: webfactory/ssh-agent@v0.9.0
        with:
          # Sua chave SSH privada para acessar a VPS
          ssh-private-key: ${{ secrets.SSH_KEY_PRIVATE }}

      - name: 游 Executar Deploy via SSH
        # O comando SSH se conecta na VPS e executa os comandos de deploy
        # O GitHub Actions j치 injetou as 'env' (secrets) no ambiente deste job,
        # portanto, o SSH pode pass치-las adiante.
        run: |
          # 1. Conecta-se  VPS
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
            # 2. Navega para o diret칩rio do projeto na VPS
            cd /caminho/para/seu/projeto
            
            # 3. Puxa a 칰ltima vers칚o do c칩digo (necess치rio para o docker-compose build)
            git pull origin main
            
            # 4. Executa o Docker Compose. 
            # O '-d' roda em background, o '--build' reconstr칩i a imagem Node
            # As vari치veis de ambiente exportadas pelo GitHub Actions (env:)
            # s칚o herdadas e usadas pelo docker-compose.yml (sintaxe ${VARIAVEL})
            
            # Exporte todas as vari치veis antes de rodar o docker-compose
            export POSTGRES_DB='$POSTGRES_DB'
            export POSTGRES_USER='$POSTGRES_USER'
            export POSTGRES_PASSWORD='$POSTGRES_PASSWORD'
            export PGPORT='$PGPORT'
            export HOST='$HOST'
            export KEY='$KEY'
            export DATABASE_URL='$DATABASE_URL'
            export USERNAME='$USERNAME'
            
            # Agora executa a orquestra칞칚o
            docker-compose up -d --build
            
            # Exibe o status da orquestra칞칚o para debug (Opcional, mas 칰til)
            docker-compose ps
          EOF