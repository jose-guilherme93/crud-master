name: CI/CD Pipeline - Build, Test e Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check:
    name: üß™ Lint e Testes Unit√°rios
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Configurar pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Habilitar cache de depend√™ncias
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Instalar depend√™ncias
        run: pnpm install --frozen-lockfile


  integration-test:
    name: üê≥ Testes de Integra√ß√£o (Docker)
    runs-on: ubuntu-latest
    needs: check

    env:
      POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      HOST_DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
      CONTAINER_DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/${{ secrets.POSTGRES_DB }}

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configurar pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Habilitar cache de depend√™ncias
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Instalar depend√™ncias (para o runner)
        run: pnpm install --frozen-lockfile

      - name: Criar .env para docker-compose
        run: |
          echo "POSTGRES_USER=${{ env.POSTGRES_USER }}" > .env
          echo "POSTGRES_PASSWORD=${{ env.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_DB=${{ env.POSTGRES_DB }}" >> .env
          echo "JWT_SECRET=${{ env.JWT_SECRET }}" >> .env
          echo "DATABASE_URL=${{ env.CONTAINER_DATABASE_URL }}" >> .env
          echo "PGHOST=postgres" >> .env
          echo "PGPORT=5432" >> .env

      - name: Buildar e iniciar servi√ßos (Docker Compose)
        run: docker-compose up -d --build

      - name: Aguardar PostgreSQL ficar pronto
        run: |
          until docker-compose exec postgres pg_isready -U ${{ env.POSTGRES_USER }} -d ${{ env.POSTGRES_DB }}; do
            sleep 2
          done

      - name: Aguardar aplica√ß√£o (e migra√ß√µes)
        run: |
          until [ "$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3000/health)" -eq 200 ]; do
            sleep 5
          done

      - name: Executar Testes de Integra√ß√£o
        run: pnpm run test:integration
        env:
          DATABASE_URL: ${{ env.HOST_DATABASE_URL }}
          JWT_SECRET: ${{ env.JWT_SECRET }}
          NODE_ENV: test

      - name: Parar servi√ßos (Cleanup)
        if: always()
        run: docker-compose down

  build-and-push:
    name: üöÄ Buildar e Publicar Imagem
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no GitHub Container Registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extrair metadados (tags) da imagem
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Buildar e enviar imagem
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max