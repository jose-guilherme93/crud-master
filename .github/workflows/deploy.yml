# .github/workflows/deploy.yml

name: CD - Deploy R치pido para VPS

on:
  push:
    branches:
      - main # Dispara o deploy no push para a branch principal

jobs:
  deploy:
    runs-on: ubuntu-latest
   

    steps:
      - name: 拘勇 Checkout do Reposit칩rio
        uses: actions/checkout@v4

      - name: 游댐 Configurar Acesso SSH com Chave Privada
        # Injeta a chave SSH no agente do runner para SCP e SSH.
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KEY}}

      - name: 游닍 Enviar Arquivos com SCP
        # Copia todos os arquivos e pastas necess치rios para o build e compose da VPS.
        # Ajuste a lista de arquivos/pastas conforme a estrutura real do seu projeto.
        run: |
          REMOTE_DIR=/var/www/gamecatalog
          SSH_USER=${{ secrets.USERNAME }}
          HOST=${{ secrets.HOST }}
          
          # Cria o diret칩rio remoto se n칚o existir, ignorando erros se j치 existir
          ssh -o StrictHostKeyChecking=no $SSH_USER@$HOST "mkdir -p $REMOTE_DIR"

          echo "Iniciando c칩pia dos arquivos..."
          
          # Lista de arquivos/pastas a serem copiados (EXEMPLO)
          # Voc칡 deve incluir tudo que o Dockerfile e docker-compose precisam:
          FILES_TO_COPY="./docker-compose.yml ./Dockerfile ./src ./package.json ./pnpm-lock.yaml" 
          
          # C칩pia usando SCP
          scp -r -o StrictHostKeyChecking=no $FILES_TO_COPY $SSH_USER@$HOST:$REMOTE_DIR/
          echo "C칩pia conclu칤da via SCP."

      - name: 丘뙖잺 Executar Deploy Remoto (Build & Up)
        # Conecta-se  VPS via SSH e executa o Docker Compose Up,
        # injetando todas as secrets como vari치veis de ambiente para o compose.
        run: |
          REMOTE_DIR=/var/www/gamecatalog
          SSH_USER=${{ secrets.USERNAME }}
          HOST=${{ secrets.HOST }}
          
          # Conecta via SSH e executa os comandos
          ssh -o StrictHostKeyChecking=no $SSH_USER@$HOST << 'EOF'
            
            # Navega para o diret칩rio de deploy
            cd $REMOTE_DIR

            echo "Injetando .env e reiniciando servi칞os..."

            # 游 INJE칂츾O R츼PIDA DE SECRETS DIRETAMENTE NO COMANDO DOCKER COMPOSE
            # Isso garante que o docker-compose lendo "${VAR}" no arquivo yaml
            # encontre o valor no ambiente.
            
            POSTGRES_DB="${{ secrets.POSTGRES_DB }}" \
            POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
            POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            PGPORT="${{ secrets.PGPORT }}" \
            HOST="${{ secrets.HOST }}" \
            KEY="${{ secrets.KEY }}" \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            USERNAME="${{ secrets.USERNAME }}" \
            docker compose up -d --build --force-recreate
            
            echo "Deploy conclu칤do!"
          EOF