name: Deploy na VPS de Produção

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. Checkout do Código
        uses: actions/checkout@v4

      - name: 2. Configurar Variáveis de Ambiente e Arquivos de Deploy
        # Usamos pipe (|) para indicar que é um bloco literal de várias linhas
        run: |
          # Cria um arquivo .env de produção na pasta do projeto, obtendo da Secret
          echo "${{ secrets.PROD_ENV }}" > .env
          
          # Cria o arquivo docker-compose.prod.yml
          # Usamos cat <<'EOF' para que o shell não expanda as variáveis de ambiente ($PG_USER, etc.)
          cat <<'EOF' > docker-compose.prod.yml
            version: '3.8'

            services:
            app:
                build:
                context: .
                dockerfile: Dockerfile
                container_name: gamecatalog_app
                restart: always
                ports:
                - "3000:3000"
                environment:
                # As variáveis são lidas do .env na VPS
                PG_HOST: postgres
                PG_USER: ${PG_USER} 
                PG_PASSWORD: ${PG_PASSWORD}
                PG_DATABASE: ${PG_DATABASE}
                NODE_ENV: production
                JWT_SECRET: ${JWT_SECRET}
                depends_on:
                - postgres
                env_file:
                - .env # Linka o arquivo .env criado acima
                
            postgres:
                image: postgres:15
                container_name: postgres_crud
                restart: always
                environment:
                POSTGRES_USER: ${PG_USER}
                POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
                POSTGRES_DB: ${POSTGRES_DB}
                volumes:
                - pgdata:/var/lib/postgresql/data

            volumes:
            pgdata:
            EOF

                - name: 3. Transferir Arquivos via SCP
                    uses: appleboy/scp-action@v0.1.7
                    with:
                    host: ${{ secrets.HOST }}
                    username: ${{ secrets.USERNAME }}
                    key: ${{ secrets.KEY }}
                    target: /home/${{ secrets.USERNAME }}/gamecatalog
                    source: ".env,Dockerfile,package.json,pnpm-lock.yaml,tsconfig.json,src/,scripts/,docker-compose.prod.yml"
                    overwrite: true

                - name: 4. Executar Deploy Remoto via SSH
                    uses: appleboy/ssh-action@v1.0.3
                    with:
                    host: ${{ secrets.HOST }}
                    username: ${{ secrets.USERNAME }}
                    key: ${{ secrets.KEY }}
                    script: |
                        cd /home/${{ secrets.USERNAME }}/gamecatalog
                        
                        # Garante que o usuário tem permissão para rodar docker e acessar os arquivos
                        sudo chown -R ${{ secrets.USERNAME }}:${{ secrets.USERNAME }} .
                        
                        # Stop e remove os contêineres antigos, se existirem
                        docker compose -f docker-compose.prod.yml down
                        
                        # BUILD & START: Constrói a imagem (otimizada) e sobe os contêineres
                        docker compose -f docker-compose.prod.yml up -d --build --force-recreate
                        
                        # Limpeza: remove imagens antigas não usadas
                        docker image prune -f
                        
                      
                        docker compose -f docker-compose.prod.yml ps