# .github/workflows/main.yml
name: CI/CD Pipeline - SCP and SSH Deploy

on:
  push:
    branches:
      - main # Roda o pipeline toda vez que houver um push na branch main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup SSH
        # Configura a chave privada para os passos de SCP e SSH subsequentes
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.KEY }}

      - name: Preparar e Compactar Arquivos para SCP
        # Cria um arquivo tarball (tar.gz) com todo o contexto de build
        run: tar -czf app.tar.gz .
        
      - name: Transferir Arquivos (SCP) para a VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          # O arquivo compactado a ser copiado
          source: "app.tar.gz" 
          # O diretório de destino na VPS. Mantenha o nome do arquivo.
          target: "/tmp" 
          # Garante que ele use a chave SSH configurada no passo anterior
          key: ${{ secrets.KEY }}

      - name: Conectar na VPS e Implantar (SSH)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          # Assegure que as variáveis do .env existam no diretório de deploy
          script: |
            # 1. Diretório de Deploy
            APP_DIR="/var/www/gamecatalog"
            
            # 2. Cria o diretório se não existir
            mkdir -p $APP_DIR
            
            # 3. Move o tarball para o diretório de deploy
            mv /tmp/app.tar.gz $APP_DIR/app.tar.gz
            
            # 4. Navega até o diretório
            cd $APP_DIR
            
            # 5. Descompacta e sobrescreve (o .env deve ser mantido)
            echo "Descompactando novos arquivos e código..."
            # O comando --overwrite garante que o código novo seja aplicado
            tar -xzf app.tar.gz --overwrite
            
            # 6. Remove o arquivo temporário
            rm app.tar.gz
            
            # 7. Parar e remover containers antigos
            echo "Parando e removendo containers antigos..."
            docker compose down 
            
            # 8. Reconstruir e rodar os serviços em background
            # O --build é crucial aqui, pois a imagem será construída na VPS
            echo "Construindo e iniciando os serviços..."
            docker compose up -d --build
            
            echo "Deploy concluído!"